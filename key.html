<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROVISIOON - Digital Key</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #001a33; color: #fff; text-align: center; margin: 0; padding: 40px 20px; }
        #room { font-size: 20px; margin-bottom: 20px; color: #00d4ff; }
        .slider-container { margin: 40px auto; width: 90%; max-width: 350px; }
        .slider { -webkit-appearance: none; width: 100%; height: 60px; background: #003366; border-radius: 50px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 60px; height: 60px; border-radius: 50%; background: #00d4ff; cursor: pointer; border: 3px solid #fff; }
        #status { margin-top: 20px; font-size: 18px; color: #00d4ff; }
        #expired-msg { font-size: 22px; margin-top: 100px; color: #ff5252; display: none; }
    </style>
</head>
<body>
    <h1 id="guest-name">Hello!</h1>
    <div id="room">Room ...</div>

    <div id="slider-area" class="slider-container">
        <input type="range" min="0" max="100" value="0" id="unlock-slider" class="slider">
        <div id="status">Slide to unlock →</div>
    </div>

    <div id="expired-msg"></div>

    <script>
        const p = new URLSearchParams(window.location.search);
        const room = p.get("room");
        const name = p.get("name");
        const start = p.get("start");
        const end = p.get("end");
        const now = new Date();

        document.getElementById("guest-name").innerText = "Hello, " + name;
        document.getElementById("room").innerText = "Room " + room;

        const slider = document.getElementById("unlock-slider");
        const sliderArea = document.getElementById("slider-area");
        const expiredMsg = document.getElementById("expired-msg");
        const status = document.getElementById("status");

        if (now < new Date(start)) {
            sliderArea.style.display = "none";
            expiredMsg.innerText = "⏳ Access not active yet";
            expiredMsg.style.display = "block";
        } else if (now > new Date(end)) {
            sliderArea.style.display = "none";
            expiredMsg.innerText = "❌ Access expired";
            expiredMsg.style.display = "block";
        }

        slider.oninput = async () => {
            if (slider.value >= 95) {
                slider.value = 100;
                status.innerText = "Verifying...";

                const res = await fetch('/api/unlock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room, start, end })
                });

                const result = await res.json();
                if (result.success) {
                    status.innerText = "Door Unlocked!";
                    setTimeout(() => { slider.value = 0; status.innerText = "Slide to unlock →"; }, 3000);
                } else {
                    alert(result.message);
                    location.reload();
                }
            }
        };
    </script>
</body>
</html>
